# 修了課題(その2) データクレンジング簡易ツールの開発  
背景と要求事項を読み仕様に準拠したプログラムを完成させなさい。  

## 背景  
ABCデータサイエンスはお客様から様々なRAWデータをCSVファイルで預かっているが、データに揺らぎがあるため、そのままでは機械学習に使用することができずクレンジングのコストが課題となっている。  
データのクレンジングは前処理として必須作業であるにも関わらず、各CSVファイルおよび各項目ごとにクレンジングの内容が異なるため、手作業では限界があり、一旦はツールを検討したが、  

* ABCデータサイエンスは独自のクレンジング処理がかなりある。またこの部分は外部に情報を漏らしたくない  
* 独自のクレンジング処理は今後も増えることが確実  

という2点を考慮し、スクラッチ開発のほうがトータルではコストが安いと考えた。  
しかし、ゼロからパッケージを開発する技術はないためベース部分を開発してもらい、独自のクレンジング処理については自社で開発できるようなデザインを採用してもらい、プラグイン形式で簡単に追加できるようにしたいと考えている。  
なおプログラミング言語については、当社でも数人の技術者がいるPythonでの実装を希望している。  
あなたはABCデータサイエンスからデータを整形するパッケージのベース部分の開発の依頼を受けた。  

## 要求事項  
ABCデータサイエンスが希望するパッケージはデータのクレンジングを行うベース部分を作成することである。  
ベース部分というのは次のことをさす。  
* 入力データ(CSV)を読み込む処理  
  入力データはCSVのみとする。文字コードはUTF-8で、囲み文字はあり、なしが混在している。  
  拡張性を考えれば、さまざまな形式を指定できるほうが良いが、ABCデータサイエンスでは、むしろ仕様を簡潔にしたほうが使い勝手がいいと考えており、CSVに限定している。  
* データのクレンジング方法の指定  
  クレンジングの設定は入力データであるCSVファイルの各項目で異なるため、クレンジング設定ファイルを指定する形にしたいと考えている。  
  クレンジング設定ファイルはCSV形式で項目番号,関数名,引数の3項目のレイアウトを検討している。  
  関数名というのは処理名と読み替えてもよい。処理に際しいくつかの引数(パラメータ)が必要なため関数と呼ぶことにしている。  
  引数が複数ある場合はカンマで区切る。その場合は囲み文字が必要。カンマを引数として使う場合は\でエスケープを行う。  

|項目番号|関数名|引数|  
|:--:|:--:|:--:|  
|1|trim||  
|1|substr|1,3|  
|2|replace_reg|^$,None|  
|3|format_date|YYYY/MM/DD HH:MI:SS|  
|..|..|..|  

* クレンジング設定ファイルに従った処理  
  本パッケージは入力データであるCSVファイルから1行読み出し、クレンジング設定ファイルに従ったクレンジング行い、出力ファイルに出力する。これを入力が終わるまで繰り返す。  
  読み込んだ1行に対し、クレンジング設定ファイルに書かれた全処理を行う。  
  例えば上記の例の場合、  
  * 1項目目はまずtrim(前後の空白をカット)を行い、ついでsubstr(切り出し)を行う。  
  * 2項目目はreplace_reg(正規表現による置換)を行う。上記の例の場合、空データをNoneに置換する。  
  * 3項目目は入力データをformat_date(日付を指定された形式にフォーマット変換)を行う。  

  クレンジング設定ファイルに記載されている項目番号より入力データの項目が少なかった場合の挙動については検討中である。  
  (エラーにするか、単に無視するか)。が、とりあえずは単に無視して欲しい。  

* 単体のコマンド形式での提供  
  ABCデータサイエンスは前処理の自動化のため、コマンド形式で実行したいと考えている。  
  また複数台のホストに展開しやすいよう、DBなど他のサービスなどを使用しないシンプルな作りにして欲しい。  

* 拡張性の容易なデザインの採用    
  ABCデータサイエンスがスクラッチ開発にこだわった一番の要因がこのポイントである。  
  拡張性が容易になるよう、関数の処理内容は、"関数名.py"というファイルに記述し、このファイルを実行時に自動でインポートできるようにしたい。  
  例えば次のディレクトリ構成の場合、trim, substr, replace_reg, format_dateの4関数が使用可能である。  
  もし新しい関数format_numを追加したい場合は、単にfuncディレクトリにformat_num.pyを置くだけでよい。  
  funcの配下の"関数名.py"をプラグインと呼び、ABCデータサイエンスはこのプラグインだけを開発していけば、容易に拡張することができる。  
```
    datacleansing.py
       func/trim.py
       func/substr.py
       func/replace_reg.py
       func/format_date.py
```

* プラグインのインターフェースについて  
  funcの下に"関数名.py"のファイルを配置するだけで、その関数が使用可能になるということはすでに述べたが、プラグインである"関数名.py"は、以下に示す初期処理と変換処理を行う2つのインターフェースを実装する。  
  後処理(term_func)の実装についても検討したが、現時点では不要となった。  
  ベース部分はクレンジング設定ファイルから各関数(プラグイン)と引数を読み取り、各プラグインのinit_funcをコールしfunc_dataを得る。  
  入力データの変換処理に、main_funcを呼び出すが、その第一引数にはinit_funcから返却されたfunc_dataを渡し、第二引数には入力データの該当項目を渡す。  
``` python
def init_func(param):
   """ paramは各関数に渡す引数。ここで初期処理を行う """
   pass #do something
   return func_data #各プラグイン固有データ。main_funcの第一引数で使用される

def main_func(func_data, data):
   """ dataは処理対象とする入力データ。func_dataはinit_funcの戻り値 ここで実際の変換処理を行う"""
   pass #do something
   return 処理後のデータ #このデータが変換後のデータとして出力される(もしくは次の変換の入力データになる)
```

* サンプルプラグイン関数の提供  
  以上が大まかな要求事項であるが、実際にプラグインを追加する際の参考にしたいため、4つのプラグイン関数をサンプルとして提供してもらいたいと考えている。  
  * **trim**  引数なし  
    前後の空白文字列(スペース、タブ、改行)をカットする  
  * **substr** *start*, *len*  
    startからlenで指定された文字数分のみ切り出す(lenとあるがバイト数ではなく文字数)  
    `AあBいCう`に対しsubstr(2,3)を指定すると`あBい`となる  
  * **replace_reg** *pattern*, *replacement*  
    入力データに対し正規表現による置換を行う。  
    後方参照の使用(\を使用する)もサポートすること  
    例えば、`12345-678-8901`に対しreplace_reg(\d+-(\d+)-\d+,\1)を指定すると`678`になる  
    もしパターンにマッチしなかった場合は無変換とする。  
    例えば、`ABC`に対しreplace_reg(\d+-(\d+)-\d+,\1)を指定すると`ABC`になる  
  * **format_date** *formatString*  
    自動判別した入力データの日時を指定された日時フォーマットに変換する。  
    日付の対象は1900年1月1日(明治33年1月1日)以降としそれ以前の年数はエラーとする。  
    サポートするフォーマットは次の通り、これ以外の文字はそのまま出力する。  
    * YYYY : 西暦年（4 桁）  
    * EEYY : 元号＋和暦年（大正10、昭和25 など）  
      表記はExcelに合わせる。Excelの場合元年は1年となる。また年数は前0詰め2桁ではなく1桁である  
    * MM : 月（01 ～ 12）  
    * mm : 月（1 ～ 12）  
    * DD : 日（01 ～ 31）  
    * dd : 日（1 ～ 31）  
    * HH : 時間（00 ～ 23）  
    * MI : 分（00 ～ 59）  
    * SS : 秒（00 ～ 59）  

    例えば`平成26年12月11日 11:13:15`をformat_date(YYYY-MM-DD HH:MI:SSです)を指定すると`2014-12-11 11:13:15です`となる。  

    自動判別する入力データ(2006/01/02 15:04:05を例にとる)は日付部(2006/01/02)と時刻部(15:04:05)で構成されている。  
    日付部と時刻部は1つ以上のスペースで区切られている。スペースなしの場合(2006/01/0215:04:05)は日付と判定しない。  
    時刻部はコロンで区切られている(HH:MI:SS)が、省略されている場合もある。省略されている場合は00:00:00とみなす。  
    日付部は次の種類とし、それ以外は日付と判断しない。  
```
    2006/01/02        #YYYY/MM/DD
    2006-01-02        #YYYY-MM-DD
    2006/1/2          #YYYY/mm/dd
    2006-1-2          #YYYY-mm-dd
    平成18年1月2日    #EEYY年mm月dd日
    平成18年01月02日  #EEYY年MM月DD日

    ※前ゼロあり、なしの混在、つまり
    2006-1-02        #YYYY-mm-DD
    2006-01-2        #YYYY-MM-dd
    のような入力はあまり好ましくないが、データとしては判別できるためこれらのデータはエラーにしない(許容する)
```


## 仕様  
要求事項から落としたプログラム仕様は次の通りとする。  

* Usage  
  **datacleansing** -i *infile* -f *conffile* -o *outfile*  
  -i クレンジング対象となる入力ファイル(CSV形式)  
  -f クレンジングの条件が記載されたクレンジング設定ファイル(CSV形式)   
  -o クレンジング処理を行った結果を出力するファイル(CSV形式)  

* フォルダ構成およびプラグイン機能  
  フォルダ構成はメインプログラムであるdatacleansing.pyの下にサブフォルダfuncを作成し  
  その下に関数名と同名のpythonスクリプトを配置する構成とする。  
  関数名と同名のpythonスクリプトがある場合は、その関数が使用できるよう実装すること  
  またfuncフォルダに新たにスクリプトを配置した場合は、以降の変換ではその関数が使用可能になるよう実装すること  

* エラー処理  
  プラグイン(関数)内でエラーが発生した場合は、プラグイン(関数)側で以下にあげる例外を発生させることができる。  
  ベース部分は次の例外を補足できるようにすること  
  * SyntaxError  
    プラグイン(関数)側で引数不正の場合に使用する  
    例えば引数省略不可で引数がない場合、逆に多い場合  
  * ValueError  
    プラグイン(関数)側で期待している型と実際の型が異なるときに使用する  
    例えば日付処理で日付として成立しないデータが来た場合  
    また型としては正しいが、業務ロジック的に正しくない場合にも使用する  
    例えば1～3までしか許容しない項目に4が来た場合  

  これらの例外を補足した場合は例えば次のようなエラーメッセージを出して直ちに終了する  
  ```python
  例外が発生しました。行数(1) 項目番号(3)
  理由:対象のデータは日付文字列ではありません
  データ:あいうえお
  ```

* 4つの関数の実装  
  要求事項を満たすため、4つのプラグイン(関数)であるtrim, substr, replace_reg, format_dateを実装すること  
  プラグイン(関数)は決められたインタフェース(init_func, main_func)を持っているためunittestを行うことが容易である。  
  format_dateについては、自分で作成したformat_date.pyに対しtest_format_date.pyを実行し、unittestがすべてpassすることを確認せよ。  
  ```
  > python -m unittest -v tests/test_format_date.py
  .....
  ----------------------------------------------------------------------
  Ran 5 tests in 0.003s
  
  OK
  ```

## 修了条件  
次のすべての条件を満たした場合、本課題およびPython研修基礎編の修了を認定する。  
* pylintが10.0(4つのプラグインformat_data.py, substr.py, trim.py, replace_reg.pyも含む)  
  ```
  > python -m pylint datacleansing.py func/format_date.py func/replace_reg.py func/substr.py func/trim.py

  --------------------------------------------------------------------
  Your code has been rated at 10.00/10 (previous run: 10.00/10, +0.00)
  ```
* ソースレビュー完了  
* format_dateのunittestをクリア  
  ```
  > python -m unittest -v tests/test_format_date.py
  .....
  ----------------------------------------------------------------------
  Ran 5 tests in 0.005s

  OK
  ```
* サンプルファイルを実行し、出力結果がサンプルと一致する  
  ```
  > python datacleansing.py -i sample.in -f sample.conf -o out
  > fc out sample.out
  ```
